<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>THE INDEX: PRESCRIPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <style>
    :root {
      --index-blue: #a0eaff;
      --index-red: #ff3b3b;
      --current-theme: var(--index-blue);
    }

    html, body { 
      margin: 0; height: 100%; 
      background-color: #020202; 
      color: var(--current-theme);
      font-family: 'Pixelify Sans', sans-serif; 
      display: flex; justify-content: center; align-items: center;
      overflow: hidden; transition: color 0.5s ease;
    }

    body::before {
      content: " "; display: block; position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
      z-index: 100; background-size: 100% 4px, 4px 100%; pointer-events: none;
    }
       
.secret-mode {
  animation: screenFlicker 0.08s infinite;
}

.secret-mode #prescript-text {
  animation: textGlitch 0.15s infinite alternate;
  text-shadow:
    2px 0 #ff00ff,
    -2px 0 #00ffff,
    0 0 8px #8b00ff;
  letter-spacing: 2px;
}

/* Screen flicker */
@keyframes screenFlicker {
  0% { opacity: 1; }
  50% { opacity: 0.85; }
  100% { opacity: 1; }
}

/* Text distortion */
@keyframes textGlitch {
  0% { transform: translate(0); }
  20% { transform: translate(-2px, 1px); }
  40% { transform: translate(2px, -1px); }
  60% { transform: translate(-1px, -2px); }
  80% { transform: translate(1px, 2px); }
  100% { transform: translate(0); }
}
    #container {
      text-align: center; padding: 40px; width: 95%; max-width: 900px;
      position: relative; z-index: 10;
    }

    #header { 
      font-size: 14px; letter-spacing: 3px; margin-bottom: 20px; opacity: 0.6; 
      text-shadow: 0 0 5px var(--current-theme); 
    }

    #logo {
      width: 250px; height: auto; margin-bottom: 20px;
      opacity: 0.8;
    }
      
    #prescript-text { 
      font-size: 22px; line-height: 1.5; min-height: 200px; 
      text-shadow: 0 0 8px var(--current-theme); 
      font-weight: 500;
      display: flex; flex-direction: column; justify-content: center;
    }

    #action-btn {
      margin-top: 30px;
      padding: 12px 35px;
      background: transparent;
      border: 1px solid var(--current-theme);
      color: var(--current-theme);
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 18px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s ease;
      animation: pulse 2.5s infinite;
    }

    #action-btn:disabled {
      opacity: 0.2;
      cursor: not-allowed;
      animation: none;
    }

    #action-btn:hover:not(:disabled) {
      background: var(--current-theme);
      color: #020202;
      box-shadow: 0 0 20px var(--current-theme);
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="header">THE WILL OF THE CITY</div>
    <img id="logo" src="index_logo.png" alt="INDEX">
    <div id="timer-display" style="font-family: monospace; color: var(--index-red); font-size: 1.5rem; margin-bottom: 10px; min-height: 1.5rem;"></div>
    <div id="prescript-text">...WAITING FOR SYNCHRONIZATION...</div>
    <button id="action-btn">Receive</button>
  </div>

<script>
  window.onerror = function(msg, url, line) { alert("Error: " + msg + "\nLine: " + line); };

  const sub_dict = {
    verbs: ["Nod to", "Tap", "Trace a line near", "Stand behind", "Mirror the posture of", "Whisper to", "Circle", "Point toward", "Adjust the collar of", "Sigh near", "Place a hand on", "Shift weight toward", "Ignore", "Bow to", "Wave at", "Wait beside", "Touch the shoulder of", "Hand a coin to", "Offer a seat to", "Hum to", "Check the watch of", "Step into the shadow of", "Inhale the scent of", "Adjust the glasses of", "Brush the sleeve of", "Count the heartbeats of", "Exhale toward", "Pivot away from", "Observe the reflection of"],
    details: ["the left side of", "the shadow of", "the reflection of", "the personal space of", "the path ahead of", "the right shoulder of", "the hand of", "the bag of", "the glasses of", "the pocket of", "the hair of", "the sleeve of", "the wrist of", "the ear of", "the hem of the coat of", "the watch-face of", "the dominant hand of", "the thumb-nail of", "the lapel of"],
    traits: ["wearing denim", "holding a phone", "with tired eyes", "carrying a bag", "wearing white shoes", "with a red garment", "looking at the sky", "checking the time", "leaning against a wall", "walking briskly", "with messy hair", "wearing a scarf", "holding a drink", "wearing spectacles", "carrying a book", "wearing a hat", "holding an umbrella", "with a backpack", "looking lost", "wearing gloves", "holding a key", "in a uniform", "wearing a ring", "with a mask", "wearing a watch", "with headphones", "holding a coin", "looking at a wristwatch", "holding a newspaper"],
    triggers: ["a car horn sounds", "a bird flies past", "a door latches", "someone laughs", "a white vehicle passes", "the wind shifts", "you feel a chill", "a phone rings", "someone coughs", "a light flickers", "you hear footsteps", "the temperature drops", "you smell ozone", "you smell coffee", "a dog barks", "someone calls a name", "a light turns green", "you see a red sign", "a leaf falls", "you blink N times", "you count N heartbeats", "a bell rings", "the air feels damp", "you see a yellow object", "the crowd thins", "a coin hits the ground", "a siren blares"],
    subjects: ["the price of ink", "a forgotten debt", "the weight of the City", "a dream about water", "the scent of old paper", "a silent agreement", "the shape of a shadow", "a missed opportunity", "the color of the sky", "a secret wish", "the taste of iron", "the path not taken", "a cold breeze", "the sound of rain", "a lost key", "the roots of a tree", "a drop of ink", "the concept of time", "the geometry of the district", "the silence between breaths"],
    durations: ["for N seconds", "for N breaths", "until the target moves N steps", "for N minutes", "for the duration of N heartbeats", "until N shadows pass", "for a count of N"],
    deadlines: ["within N minutes", "before the sun shifts N degrees", "within the next N hours", "before the next N bells", "within N steps", "within N blocks of your current location"]
  };

  let isClearState = false;
  let isProcessing = false;
  let currentPrescriptText = "";
  let countdownInterval;
  let activeLogTimers = [];

  const displayElement = document.getElementById('prescript-text');
  const actionBtn = document.getElementById('action-btn');
  const timerDisplay = document.getElementById('timer-display');
  const fullCharset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';


  const receiveSound = new Audio('limbus_index_beeper.mp3');
  const clearSound = new Audio('indexbeep_notification.mp3');
  const themeMusic = new Audio('Children_of_the_City.mp3');
  themeMusic.loop = true;
  themeMusic.volume = 0.5;
  
  const logContainer = document.createElement('div');
  logContainer.id = "prescript-log";
  logContainer.style = "margin-top: 40px; text-align: left; font-size: 12px; border-top: 1px solid #333; padding-top: 10px; max-height: 200px; overflow-y: auto;";
  document.getElementById('container').appendChild(logContainer);

  const logBtn = document.createElement('button');
  logBtn.innerText = "Log Prescript";
  logBtn.id = "log-btn";
  logBtn.style = "display: none; margin-top: 10px; background: none; border: 1px solid var(--current-theme); color: var(--current-theme); font-family: inherit; cursor: pointer; padding: 5px 15px;";
  document.getElementById('container').insertBefore(logBtn, logContainer);

  function generatePrescript() {
    if (Math.random() < 0.001) {
      document.documentElement.style.setProperty('--current-theme', '#8b00ff');
      document.body.classList.add("secret-mode");
      return "/// SIGNAL INTERCEPTED /// YOU WERE NOT MEANT TO SEE THIS ///";
    }
    if (Math.random() < 0.02) {
      document.documentElement.style.setProperty('--current-theme', 'var(--index-red)');
      return "CRITICAL: THE WILL IS COMPROMISED. DO NOT MOVE. WAIT FOR FURTHER INSTRUCTION.";
    }

    document.documentElement.style.setProperty('--current-theme', 'var(--index-blue)');
    const getRand = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const getN = () => Math.floor(Math.random() * 75) + 1;

    let finalStr = `${getRand(sub_dict.verbs)} ${getRand(sub_dict.details)} ${getRand(sub_dict.durations)}, ${getRand(sub_dict.deadlines)}, a person ${getRand(sub_dict.traits)}, exactly after ${getRand(sub_dict.triggers)}, regarding ${getRand(sub_dict.subjects)}, at a distance of N steps from the target.`;
    
    while (finalStr.includes("N")) { finalStr = finalStr.replace("N", getN()); }
    return finalStr.toUpperCase();
  }

  function decodeText(text) {
    isProcessing = true;
    actionBtn.disabled = true;
    logBtn.style.display = "none";
    timerDisplay.innerText = "";
    clearInterval(countdownInterval);

    let iterations = 0;
    const interval = setInterval(() => {
      displayElement.innerHTML = text.split("").map((char, index) => {
        if (index < iterations) return text[index];
        return fullCharset[Math.floor(Math.random() * fullCharset.length)];
      }).join("") + '<span class="cursor"></span>';

      if (iterations >= text.length) {
        clearInterval(interval);
        isProcessing = false;
        actionBtn.disabled = false;
        actionBtn.innerText = "Clear";
        isClearState = true;
        currentPrescriptText = text;
        
        if (text.includes("WITHIN") || text.includes("BEFORE")) {
          startDeadline(text);
          logBtn.style.display = "inline-block";
        }
      }
      iterations += 0.4;
    }, 6);
  }

  function startDeadline(text) {
    const match = text.match(/\d+/);
    let totalSeconds = match ? parseInt(match[0]) : 60;
    if (text.includes("MINUTES")) totalSeconds *= 60;
    else if (text.includes("HOURS")) totalSeconds *= 3600;

    countdownInterval = setInterval(() => {
      totalSeconds--;
      timerDisplay.innerText = `[ TIME REMAINING: ${formatTime(totalSeconds)} ]`;
      if (totalSeconds <= 0) {
        clearInterval(countdownInterval);
        triggerViolation();
      }
    }, 1000);
  }

  function formatTime(secs) {
    if (secs <= 0) return "00:00";
    let h = Math.floor(secs / 3600);
    let m = Math.floor((secs % 3600) / 60);
    let s = secs % 60;
    return `${h > 0 ? h + ':' : ''}${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
  }

  logBtn.addEventListener('click', () => {
    const entry = document.createElement('div');
    const match = currentPrescriptText.match(/\d+/);
    let secs = match ? parseInt(match[0]) : 60;
    if (currentPrescriptText.includes("MINUTES")) secs *= 60;
    else if (currentPrescriptText.includes("HOURS")) secs *= 3600;

    entry.style = "margin-bottom: 10px; border-left: 2px solid var(--index-blue); padding-left: 10px; opacity: 0.8;";
    const logText = document.createElement('div');
    logText.innerText = currentPrescriptText;
    const logTimer = document.createElement('div');
    logTimer.style.color = "var(--index-red)";
    
    entry.appendChild(logText);
    entry.appendChild(logTimer);
    logContainer.prepend(entry);

    const logInterval = setInterval(() => {
      secs--;
      logTimer.innerText = `REMAINING: ${formatTime(secs)}`;
      if (secs <= 0) {
        clearInterval(logInterval);
        logTimer.innerText = "!!! VIOLATED !!!";
        entry.style.color = "red";
      }
    }, 1000);
    
    logBtn.style.display = "none";
  });

  function triggerViolation() {
    document.documentElement.style.setProperty('--current-theme', 'var(--index-red)');
    displayElement.innerHTML = "<span style='background: red; color: white;'> !!! VIOLATION DETECTED !!! </span><br><br>THE WILL HAS BEEN IGNORED.";
  }

  function scrambleAndReset() {
    isProcessing = true;
    actionBtn.disabled = true;
    logBtn.style.display = "none";
    const clearLabel = "_CLEAR._";
    let iterations = 0;
    document.body.classList.remove("secret-mode");
    
    const interval = setInterval(() => {
      displayElement.innerHTML = clearLabel.split("").map((char, index) => {
        if (index < iterations) return clearLabel[index];
        return fullCharset[Math.floor(Math.random() * fullCharset.length)];
      }).join("");

      if (iterations >= clearLabel.length) {
        clearInterval(interval);
        setTimeout(() => {
          clearInterval(countdownInterval); 
          timerDisplay.innerText = "";
          displayElement.innerHTML = "...WAITING FOR SYNCHRONIZATION...";
          document.documentElement.style.setProperty('--current-theme', 'var(--index-blue)');
          actionBtn.innerText = "Receive";
          isClearState = false;
          isProcessing = false;
          actionBtn.disabled = false;
        }, 800);
      }
      iterations += 0.6;
    }, 15);
  }

  actionBtn.addEventListener("click", () => {
    if (themeMusic.paused) themeMusic.play().catch(e => {});
    if (isProcessing) return;
    if (!isClearState) {
      receiveSound.play().catch(e => {});
      decodeText(generatePrescript());
    } else {
      clearSound.play().catch(e => {});
      scrambleAndReset();
    }
  });
</script>

</body>
</html>
