<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>THE INDEX: PRESCRIPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">

  <style>
    :root {
      --index-blue: #a0eaff;
      --index-red: #ff3b3b;
      --current-theme: var(--index-blue);
    }

    html, body { 
      margin: 0; min-height: 100%; 
      background-color: #020202; 
      color: var(--current-theme);
      font-family: 'Pixelify Sans', sans-serif; 
      display: flex; flex-direction: column; align-items: center;
      overflow-x: hidden; overflow-y: auto;
      transition: color 0.5s ease;
    }

    /* Fixed background scanlines */
    body::before {
      content: " "; display: block; position: fixed;
      top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
      z-index: 100; background-size: 100% 4px, 4px 100%; pointer-events: none;
    }

    #container {
      text-align: center; padding: 20px; width: 90%; max-width: 600px;
      position: relative; z-index: 10; margin-top: 20px;
    }

    #logo {
      width: 100%; max-width: 220px; height: auto; 
      margin-bottom: 10px; opacity: 0.8;
    }

    #prescript-text { 
      font-size: clamp(16px, 4.5vw, 22px); 
      line-height: 1.5; min-height: 220px; 
      text-shadow: 0 0 8px var(--current-theme); 
      word-break: break-word; overflow-wrap: break-word;
      display: flex; flex-direction: column; justify-content: center;
      margin-bottom: 20px;
    }

    /* Button Group and Styling */
    .button-group {
      display: flex; gap: 15px; justify-content: center;
      margin-top: 10px; flex-wrap: wrap;
    }

    #action-btn, #log-btn {
      width: 160px; height: 50px;
      background: transparent; border: 1px solid var(--current-theme);
      color: var(--current-theme); font-family: inherit;
      font-size: 16px; cursor: pointer; text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.4s ease, opacity 0.5s ease, transform 0.3s ease;
    }

    #action-btn:hover:not(:disabled), #log-btn:hover {
      background: var(--current-theme); color: #020202;
      box-shadow: 0 0 15px var(--current-theme);
    }

    #action-btn:disabled { opacity: 0.2; cursor: not-allowed; }

    /* Fade Classes */
    .hidden { opacity: 0; pointer-events: none; visibility: hidden; transform: translateY(10px); }
    .visible { opacity: 1; pointer-events: auto; visibility: visible; transform: translateY(0); }

    /* Log Section Styling */
    #prescript-log {
      margin-top: 40px; text-align: left; width: 100%;
      border-top: 1px solid #333; padding-top: 20px; padding-bottom: 100px;
    }

    .log-entry {
      margin-bottom: 25px; border-left: 2px solid var(--index-blue); 
      padding-left: 15px; font-size: 13px; line-height: 1.4;
      transition: all 0.5s ease;
    }

    .log-timer {
      color: var(--index-red); font-family: monospace;
      font-size: 14px; margin-top: 5px; font-weight: bold;
    }

    .violated { border-color: var(--index-red) !important; color: var(--index-red) !important; }

    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    .pulsing { animation: pulse 2s infinite; }
  </style>
</head>

<body>
  <div id="container">
    <div id="header" style="font-size: 12px; opacity: 0.6; letter-spacing: 3px; margin-bottom: 10px;">THE WILL OF THE CITY</div>
    <img id="logo" src="index_logo.png" alt="INDEX">
    <div id="timer-display" style="font-family: monospace; color: var(--index-red); font-size: 1.2rem; min-height: 1.5rem; margin-bottom: 10px;"></div>
    <div id="prescript-text">...WAITING FOR SYNCHRONIZATION...</div>
    
    <div class="button-group">
      <button id="action-btn">Receive</button>
      <button id="log-btn" class="hidden">Log Prescript</button>
    </div>

    <div id="prescript-log"></div>
  </div>

<script>
  const sub_dict = {
    verbs: ["Nod to", "Tap", "Trace a line near", "Stand behind", "Mirror the posture of", "Whisper to", "Circle", "Point toward", "Adjust the collar of", "Sigh near", "Place a hand on", "Shift weight toward", "Ignore", "Bow to", "Wave at", "Wait beside", "Touch the shoulder of", "Hand a coin to", "Offer a seat to", "Hum to"],
    details: ["the left side of", "the shadow of", "the reflection of", "the personal space of", "the path ahead of", "the right shoulder of", "the hand of", "the bag of", "the glasses of", "the pocket of", "the ear of", "the wrist of"],
    traits: ["wearing denim", "holding a phone", "with tired eyes", "carrying a bag", "wearing white shoes", "with a red garment", "looking at the sky", "checking the time", "leaning against a wall", "walking briskly", "with messy hair", "wearing a scarf"],
    triggers: ["a car horn sounds", "a bird flies past", "a door latches", "someone laughs", "a white vehicle passes", "the wind shifts", "you feel a chill", "a phone rings", "a light flickers"],
    subjects: ["the price of ink", "a forgotten debt", "the weight of the City", "a dream about water", "the scent of old paper", "a silent agreement", "the shape of a shadow"],
    durations: ["for N seconds", "for N breaths", "until the target moves N steps", "for N minutes", "for N heartbeats"],
    deadlines: ["within N minutes", "before the sun shifts N degrees", "within the next N hours", "within N steps", "within N blocks"]
  };

  let isClearState = false;
  let isProcessing = false;
  let currentPrescriptText = "";
  let countdownInterval;
  const fullCharset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';

  const displayElement = document.getElementById('prescript-text');
  const actionBtn = document.getElementById('action-btn');
  const logBtn = document.getElementById('log-btn');
  const timerDisplay = document.getElementById('timer-display');
  const logContainer = document.getElementById('prescript-log');

  function formatTime(secs) {
    if (secs <= 0) return "00:00";
    let m = Math.floor(secs / 60);
    let s = secs % 60;
    return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
  }

  function generatePrescript() {
  const getRand = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const getN = () => Math.floor(Math.random() * 65) + 1;
  
  // Structure: [Action] [Detail] [Trait] [Duration], [Deadline], [Trigger], [Subject], [Distance]
  let s = `${getRand(sub_dict.verbs)} ${getRand(sub_dict.details)} a person ${getRand(sub_dict.traits)} ${getRand(sub_dict.durations)}, ${getRand(sub_dict.deadlines)}, exactly after ${getRand(sub_dict.triggers)}, regarding ${getRand(sub_dict.subjects)}, at a distance of N steps from the target.`;
  
  while (s.includes("N")) { s = s.replace("N", getN()); }
  return s.toUpperCase();
}

function getDeadlineSeconds(text) {
  // Regex to find the number specifically appearing before "MINUTES", "HOURS", or "STEPS"
  // This ensures "6 breaths" isn't picked up as the time limit.
  const deadlineMatch = text.match(/(\d+)\s+(MINUTES|HOURS|STEPS|BLOCKS|DEGREES)/);
  if (!deadlineMatch) return 60; // Default fallback

  let value = parseInt(deadlineMatch[1]);
  const unit = deadlineMatch[2];

  if (unit === "MINUTES") return value * 60;
  if (unit === "HOURS") return value * 3600;
  return value * 10; // "Steps" or "Blocks" as an arbitrary 10s per unit
}

function startDeadline(text) {
  let secs = getDeadlineSeconds(text);

  countdownInterval = setInterval(() => {
    secs--;
    timerDisplay.innerText = `[ TIME REMAINING: ${formatTime(secs)} ]`;
    if (secs <= 0) {
      clearInterval(countdownInterval);
      document.documentElement.style.setProperty('--current-theme', 'var(--index-red)');
      displayElement.innerHTML = "<span style='color: white; background: red; padding: 0 5px;'>!!! VIOLATION DETECTED !!!</span><br><br>THE WILL HAS BEEN IGNORED.";
    }
  }, 1000);
}

logBtn.addEventListener('click', () => {
  const entry = document.createElement('div');
  entry.className = "log-entry";
  
  let secs = getDeadlineSeconds(currentPrescriptText);

  const t = document.createElement('div');
  t.innerText = currentPrescriptText;
  
  const tm = document.createElement('div');
  tm.className = "log-timer";
  tm.innerText = `REMAINING: ${formatTime(secs)}`;
  
  entry.append(t, tm);
  logContainer.prepend(entry);
  logBtn.className = "hidden";

  const logInterval = setInterval(() => {
    secs--;
    tm.innerText = `REMAINING: ${formatTime(secs)}`;
    if (secs <= 0) {
      clearInterval(logInterval);
      tm.innerText = "!!! VIOLATED !!!";
      entry.classList.add("violated");
    }
  }, 1000);
});

actionBtn.addEventListener("click", () => {
  if (isProcessing) return;
  if (!isClearState) {
    decodeText(generatePrescript());
  } else {
    timerDisplay.innerText = "";
    clearInterval(countdownInterval);
    displayElement.innerText = "...WAITING FOR SYNCHRONIZATION...";
    document.documentElement.style.setProperty('--current-theme', 'var(--index-blue)');
    actionBtn.innerText = "Receive";
    isClearState = false;
    logBtn.className = "hidden";
    // REMOVED: logContainer.innerHTML = ""; <-- This was clearing your history!
  }
});
</script>
</body>
</html>
